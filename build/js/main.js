(()=>{let f={INVALID_PHONE_FORMAT:{message:"Формат телефону вказано неправильно",translateKey:"errorInvalidPhoneFormat"},PHONE_ALREADY_USED:{message:"Цей номер телефону вже використовується",translateKey:"errorPhoneAlreadyUsed"},PHONE_CONFIRMED_BY_ANOTHER:{message:"Цей номер телефону було підтверджено іншим користувачем",translateKey:"errorPhoneConfirmedByAnother"},VERIFICATION_EXPIRED:{message:"Час верифікації минув",translateKey:"errorVerificationExpired"},INVALID_CONFIRMATION_CODE:{message:"Неправильний код підтвердження",translateKey:"errorInvalidConfirmationCode"},VERIFICATION_LOCKED:{message:"верифікацію заблоковано. Дочекайтесь оновлення таймера",translateKey:"errorVerificationLocked"},SMS_CODE_TIMER:{message:"час, який залишився, щоб ввести код з SMS-повідомлення. Після закінчення часу можна запросити код повторно",translateKey:"smsCodeTimer"}},g="https://fav-prom.com",E="api_verification";var e=document.querySelector("#ukLeng"),t=document.querySelector("#enLeng");let a={},n="uk";function r(){var e=document.querySelectorAll("[data-translate]"),t=(e&&e.length&&e.forEach(e=>{var t=e.getAttribute("data-translate");e.innerHTML=(e=>{if(e)return a[e]||"*----NEED TO BE TRANSLATED----*   key:  "+e})(t),e.removeAttribute("data-translate")}),"en"===n&&i.classList.add("en"),void 0),r=void 0;if(t){for(var o of["uk","en"])t.classList.remove(r+o);t.classList.add(r+n)}}async function v(e){try{var t=await window.FE.socket_send({cmd:"accounting/user_phone_verify",cid:e});return console.log("verifyUserPhone response",t),t}catch(e){return console.error("Error verifying user phone:",e),e}}function _(e,t,r=!1){var o,a=t.querySelector("input"),n=t.querySelector("button");"confirmation__form"===t.id&&"true"===t.dataset.confirmationExpired&&t.querySelectorAll(".input-msg").forEach(e=>e.remove());let s=null;for(o in f)if(f[o].message===e){s=f[o];break}var i,d,l=t.querySelectorAll(".input-msg");console.log("existingMessages:",l);for(i of l)if(!i.hasAttribute("data-code-error")){if(Array.isArray(e)&&2===e.length){var c=i.querySelector(".timerWrapper");if(c){c=c.querySelector(".timer");if(c)return void(c.textContent=e[0])}}else if(i.textContent===e)return;console.log("message of existingMessages",i),i.remove()}let u=document.createElement("div");u.classList.add("input-msg"),Array.isArray(e)&&2===e.length?((l=document.createElement("div")).classList.add("timerWrapper"),l.style.minWidth=r?"65px":"45px",(d=document.createElement("span")).textContent=e[0],d.classList.add("timer"),l.appendChild(d),(d=document.createElement("span")).textContent=e[1],d.classList.add(r?"error":"warning"),e[1]===f.VERIFICATION_LOCKED.message?d.setAttribute("data-translate",f.VERIFICATION_LOCKED.translateKey):e[1]===f.SMS_CODE_TIMER.message&&d.setAttribute("data-translate",f.SMS_CODE_TIMER.translateKey),u.appendChild(l),u.appendChild(document.createTextNode(" ")),u.appendChild(d)):(u.textContent=e,s&&u.setAttribute("data-translate",s.translateKey)),u.classList.add(r?"error":"warning"),e===f.INVALID_CONFIRMATION_CODE.message?(console.log("message is INVALID_CONFIRMATION_CODE"),u.setAttribute("data-code-error","true"),a.parentNode.insertBefore(u,a.nextSibling),t.querySelectorAll(".input-msg:not([data-code-error])").forEach(e=>{u.parentNode.insertBefore(e,u.nextSibling)})):(console.log("message is ANY OTHER"),l=t.querySelector("[data-code-error]"),console.log("ANY OTHER existing",l),d=l?l.nextSibling:n,a.parentNode.insertBefore(u,d))}function h(e){return/^\+380\d{9}$/.test(e)}function p(e){e.querySelectorAll(".input-msg").forEach(e=>e.remove())}e&&(n="uk"),t&&(n="en");let y=document.getElementById("phone"),I=document.getElementById("confirmation-code"),O=document.getElementById("verification__form"),o=document.querySelector(".link__button-wrapper"),L=document.getElementById("submit-button"),s=document.querySelector(".form__wrapper"),b=document.querySelector(".form__container"),S=document.querySelector(".form__container-successBefore"),A=document.querySelector(".form__container-success"),i=(fetch(`${g}/${E}/translates/`+n).then(e=>e.json()).then(e=>{a=e,r(),new MutationObserver(function(e){r()}).observe(document.getElementById("verification"),{childList:!0,subtree:!0})}).then(async function(){if(console.log("%c init fired","color: #00ff00; font-weight: bold"),"guest"===window.FE?.user.role)s.classList.add("hidden"),o.classList.add("visible"),o.classList.remove("hidden");else{O.classList.add("visible"),O.classList.remove("hidden");let n=null;var e;let o=null,s=null,i=null,d=null,l=null,c=document.getElementById("confirmation__form"),u=document.getElementById("confirm-button");try{if(i=await(async()=>{try{var e=await window.FE.socket_send({cmd:"get_user"});return console.log("getUser response",e),e}catch(e){throw console.error("Error fetching user:",e),e}})(),d=i.cid,n=i.data.account.phone_number,e=i.data.account.account_status.find(e=>"IS_PHONE_VERIFIED"===e.alias).value,console.log("userPhoneNumber:",n),console.log("userPhoneVerified:",e),n&&e)return b.classList.add("hidden"),void S.classList.remove("hidden");O.classList.remove("hidden"),O.classList.add("visible"),y.value="+"+n}catch(e){console.error("Failed to get user:",e)}let a=(e,{confirmation:r=!1,verification:o=!1})=>{u.textContent="НАДІСЛАТИ",u.setAttribute("data-translate","sendConfirmationCode"),s&&clearInterval(s);let a=e;s=setInterval(()=>{var e,t;a<=0?(clearInterval(s),u.disabled=!1,u.textContent="НАДІСЛАТИ ПОВТОРНО",u.setAttribute("data-translate","resendConfirmationCode"),p(O),(e=document.getElementById("confirmation-code")).value="",e.required=!1,c.dataset.confirmationExpired="true",_(f.VERIFICATION_EXPIRED.message,c,"error")):(e=Math.floor(a/60),t=a%60,o&&_([`${Math.floor(a/3600).toString().padStart(2,"0")}:${Math.floor(a%3600/60).toString().padStart(2,"0")}:`+(a%60).toString().padStart(2,"0"),f.VERIFICATION_LOCKED.message],O,"error"),r&&_([e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0"),f.SMS_CODE_TIMER.message],c,!1),a--)},1e3)},m=e=>{console.log("response from verifyUserPhone inside handleVerificationResponse",e);var t,r={confirmation:!1,verification:!1};e.ok?(o=e.data.session_id,c.classList.contains("hidden")&&(O.classList.add("hidden"),O.classList.remove("visible"),c.classList.add("visible"),c.classList.remove("hidden")),r.confirmation=!0,t=e.data.phone_verification_ttl,a(t,r)):-24===e.code&&"verification_locked"===e.message.reason?(t=e.message.rest_time,L.disabled=!0,y.disabled=!0,r.verification=!0,a(t,r)):-24===e.code&&"phone_number_has_been_confirmed_by_another_user"===e.message.reason&&(L.disabled=!1,_(f.PHONE_CONFIRMED_BY_ANOTHER.message,O,"error"))};y.addEventListener("input",e=>{var t=e.target.value;y.classList.remove("is-invalid"),h(t)?p(O):y.classList.add("is-invalid"),e.target.value.slice(1)===n?(L.innerHTML="ПІДТВЕРДИТИ",L.setAttribute("data-translate","confirm")):(L.innerHTML="ЗБЕРЕГТИ",L.setAttribute("data-translate","save"))}),I.addEventListener("input",e=>{e.target.value=e.target.value.replace(/[^0-9]/g,""),5!==e.target.value.length?e.target.classList.add("is-invalid"):e.target.classList.remove("is-invalid")}),O.addEventListener("submit",async e=>{if(e.preventDefault(),console.log("%c Form submitted","color: #ff00ff; font-weight: bold",e),L.disabled=!0,h(l=e.target[0].value)){p(O);try{var t,r=i.data.account.id,o=new FormData;if(o.append("phone",l),o.append("userid",r),l!=="+"+n)console.log("TRY CHANGE USER PHONE---VERIF FORM"),"no"!==(t=await(async e=>{try{var t=await(await fetch("/accounting/api/change_user",{method:"POST",body:e})).json();return console.log("changeUserPhone response:",t),t}catch(e){throw console.error("Error changing user phone:",e),e}})(o)).error||t.error_code?"yes"===t.error&&"accounting_error_02"===t.error_code&&(L.disabled=!1,_(f.PHONE_ALREADY_USED.message,O,"error")):(p(O),n=t.phone.slice(1),L.innerHTML="ПІДТВЕРДИТИ",L.disabled=!1);else{console.log("TRY VERIFY USER PHONE---VERIF FORM");var a=await v(d);if(!a)throw a;m(a)}}catch(e){console.error("Verification process failed:",e),L.disabled=!1}}else _(f.INVALID_PHONE_FORMAT.message,O,"error"),L.disabled=!1}),c.addEventListener("submit",async e=>{if(e.preventDefault(),u.disabled=!0,"true"===c.dataset.confirmationExpired){c.dataset.confirmationExpired="false",document.getElementById("confirmation-code").required=!0;try{console.log("TRY VERIFY USER PHONE---CONF FORM");var t=await v(d);t&&m(t)}catch(e){console.error("Error resending verification code:",e)}u.disabled=!1}else{e=I.value;if(/^\d{5}$/.test(e))try{if(console.log("TRY CONFIRM USER PHONE---CONF FORM"),(await(async(e,t)=>{try{var r=await window.FE.socket_send({cmd:"accounting/user_phone_confirm",data:{confirm_code:""+e,session_id:""+t}});return console.log("confirmUserPhone response",r),r}catch(e){throw console.error("Error confirming user phone:",e),e}})(e,o)).ok){b.classList.add("hidden"),A.classList.remove("hidden");var r={userid:i.data.account.id,phone:l};try{await fetch(g+"/"+E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(e){throw console.error("Error adding verification:",e),e}await void 0}}catch(e){console.error("Error confirming code:",e),-4===e.code&&"wrong_session_or_confirm_code"===e.message.reason&&_(f.INVALID_CONFIRMATION_CODE.message,c,"error")}finally{u.disabled=!1}else console.log("inside validate fn() ---code is invalid"),I.classList.add("is-invalid"),u.disabled=!1}})}}),document.querySelector(".fav__page"));setTimeout(()=>i.classList.add("overflow"),1e3)})();