(()=>{let h={INVALID_PHONE_FORMAT:{message:"Формат телефону вказано неправильно",translateKey:"errorInvalidPhoneFormat"},PHONE_ALREADY_USED:{message:"Цей номер телефону вже використовується",translateKey:"errorPhoneAlreadyUsed"},PHONE_CONFIRMED_BY_ANOTHER:{message:"Цей номер телефону було підтверджено іншим користувачем",translateKey:"errorPhoneConfirmedByAnother"},VERIFICATION_EXPIRED:{message:"Час верифікації минув",translateKey:"errorVerificationExpired"},INVALID_CONFIRMATION_CODE:{message:"Неправильний код підтвердження",translateKey:"errorInvalidConfirmationCode"},VERIFICATION_LOCKED:{message:"верифікацію заблоковано. Дочекайтесь оновлення таймера",translateKey:"errorVerificationLocked"},SMS_CODE_TIMER:{message:"час, який залишився, щоб ввести код з SMS-повідомлення. Після закінчення часу можна запросити код повторно",translateKey:"smsCodeTimer"}},d={CONFIRMATION:"confirmation",VERIFICATION:"verification"},a="https://fav-prom.com",s="api_verification";var e=document.querySelector("#ukLeng"),t=document.querySelector("#enLeng");let o={},c=sessionStorage.getItem("locale")?sessionStorage.getItem("locale"):"uk";function r(){var e=document.querySelectorAll("[data-translate]"),t=(e&&e.length&&e.forEach(e=>{var t=e.getAttribute("data-translate");e.innerHTML=(e=>{if(e)return o[e]||"*----NEED TO BE TRANSLATED----*   key:  "+e})(t),e.removeAttribute("data-translate")}),"en"===c&&n.classList.add("en"),void 0),r=void 0;if(t){for(var a of["uk","en"])t.classList.remove(r+a);t.classList.add(r+c)}}async function l(e){try{var t=await window.FE.socket_send({cmd:"accounting/user_phone_verify",cid:e});return console.log("verifyUserPhone response",t),t}catch(e){return console.error("Error verifying user phone:",e),e}}e&&(c="uk"),t&&(c="en");let g=!1;function u(e,t,r=!1){var a,s=t.querySelector("input"),o=t.querySelector("button");document.getElementById("confirmation__form").setAttribute("data-placeholder","");let n=null;for(a in h)if(h[a].message===e){n=h[a];break}var i,d,c=t.querySelectorAll(".input-msg"),l=Array.isArray(e)&&2===e.length;for(i of c)if(l){var u=i.querySelector(".timerWrapper");if(u){u=u.querySelector(".timer");if(u)return void(u.textContent=e[0])}}else{if(i.textContent===e)return;i.querySelector(".timerWrapper")&&!l||i.remove()}let m=document.createElement("div");m.classList.add("input-msg"),l?((c=document.createElement("div")).classList.add("timerWrapper"),c.style.minWidth=g?"63px":"45px",(d=document.createElement("span")).textContent=e[0],d.classList.add("timer"),c.appendChild(d),(d=document.createElement("span")).textContent=e[1],d.classList.add(r?"error":"warning"),e[1]===h.VERIFICATION_LOCKED.message?d.setAttribute("data-translate",h.VERIFICATION_LOCKED.translateKey):e[1]===h.SMS_CODE_TIMER.message&&d.setAttribute("data-translate",h.SMS_CODE_TIMER.translateKey),m.appendChild(c),m.appendChild(document.createTextNode(" ")),m.appendChild(d)):(m.textContent=e,n&&m.setAttribute("data-translate",n.translateKey)),m.classList.add(r?"error":"warning"),e===h.INVALID_CONFIRMATION_CODE.message?(m.setAttribute("data-code-error","true"),s.parentNode.insertBefore(m,s.nextSibling),t.querySelectorAll(".input-msg:not([data-code-error])").forEach(e=>{m.parentNode.insertBefore(e,m.nextSibling)})):(d=(c=t.querySelector("[data-code-error]"))?c.nextSibling:o,s.parentNode.insertBefore(m,d))}let m=document.getElementById("phone"),f=document.getElementById("confirmation-code"),v=document.getElementById("verification__form"),p=document.getElementById("confirmation__form"),L=document.querySelector(".link__button-wrapper"),E=document.getElementById("submit-button"),_=document.getElementById("confirm-button"),I=document.querySelector(".form__wrapper"),y=document.querySelector(".loading__wrapper"),S=document.querySelector(".form__container"),b=document.querySelector(".form__container-successBefore"),A=document.querySelector(".form__container-success"),O=(document.querySelector(".loading__wrapper"),document.querySelector(".button-authorized")),C=document.querySelector(".button-notAuthorized"),N=document.querySelector(".button-success"),B=document.querySelector(".button-successBefore"),X=document.querySelector(".button-codeForm"),x=document.querySelector(".button-lang"),V=document.querySelector(".button-theme"),P=document.querySelector(".button-loading"),T=!1,D=!0,R=!1,k=!1,w=!1,F=!1,M=!1;function q(e){e.querySelectorAll(".input-msg").forEach(e=>e.remove())}fetch(`${a}/${s}/translates/`+c).then(e=>e.json()).then(e=>{o=e,r(),new MutationObserver(function(e){r()}).observe(document.getElementById("verification"),{childList:!0,subtree:!0})}).then(async function(){console.log("%c init() fired","color: #00ff00; font-weight: bold");let o="380935075493",t=()=>{console.log("Updating UI, states:",{authorized:T,notAuthorized:D,successBefore:k,success:R,loading:w,theme:F,codeForm:M});var e,t,r=document.querySelector(".form__container");D?(console.log("not authorized"),I?.classList.add("hidden"),r?.classList.remove("hidden"),L?.classList.remove("hidden"),b?.classList.add("hidden"),A?.classList.add("hidden"),y?.classList.add("hidden"),p?.classList.add("hidden")):T?(console.log("authorized"),b?.classList.add("hidden"),A?.classList.add("hidden"),r?.classList.remove("hidden"),L?.classList.add("hidden"),I?.classList.remove("hidden"),v?.classList.remove("hidden"),t=(t=(e="380935075493").toString().replace(/\D/g,"")).startsWith("380")&&12===t.length?`+${t.slice(0,3)}(${t.slice(3,5)})-${t.slice(5,8)}-${t.slice(8,10)}-`+t.slice(10,12):e,m.value=t,y?.classList.add("hidden"),p?.classList.add("hidden")):k?(console.log("successBefore"),r?.classList.add("hidden"),b?.classList.remove("hidden"),A?.classList.add("hidden")):R?(console.log("success"),r?.classList.add("hidden"),b?.classList.add("hidden"),A?.classList.remove("hidden")):w?(b?.classList.add("hidden"),A?.classList.add("hidden"),r?.classList.remove("hidden"),I?.classList.remove("hidden"),v?.classList.add("hidden"),L?.classList.add("hidden"),y?.classList.remove("hidden"),p?.classList.add("hidden")):M&&(b?.classList.add("hidden"),A?.classList.add("hidden"),r?.classList.remove("hidden"),I?.classList.remove("hidden"),v?.classList.add("hidden"),L?.classList.add("hidden"),y?.classList.add("hidden"),p?.classList.remove("hidden"))},n=(O.addEventListener("click",e=>{e.preventDefault(),console.log("authorizedButton clicked"),T=!0,D=!1,R=!1,k=!1,w=!1,F=!1,t()}),C.addEventListener("click",e=>{e.preventDefault(),console.log("notAuthorizedButton clicked"),T=!1,D=!0,R=!1,k=!1,w=!1,F=!1,t()}),B.addEventListener("click",e=>{e.preventDefault(),console.log("successBeforeButton clicked"),T=!1,D=!1,R=!1,k=!0,w=!1,F=!1,t()}),N.addEventListener("click",e=>{e.preventDefault(),console.log("successButton clicked"),T=!1,D=!1,R=!0,k=!1,w=!1,F=!1,t()}),P.addEventListener("click",e=>{e.preventDefault(),console.log("loadingButton clicked"),T=!1,D=!1,R=!1,k=!1,w=!0,F=!1,t()}),x.addEventListener("click",e=>{e.preventDefault(),console.log("langButton clicked"),"uk"===c?(sessionStorage.setItem("locale","en"),window.location.reload()):"en"===c&&(sessionStorage.setItem("locale","uk"),window.location.reload())}),V.addEventListener("click",e=>{e.preventDefault(),document.body.classList.toggle("dark")}),X.addEventListener("click",e=>{e.preventDefault(),console.log("codeFormButton clicked"),T=!1,D=!1,R=!1,k=!1,w=!1,F=!1,M=!0,t()}),t(),(e,t)=>{t===d.CONFIRMATION&&e<300&&(_.disabled=!0,_.textContent="НАДІСЛАТИ",_.setAttribute("data-translate","sendConfirmationCode"),f.disabled=!1,f.setAttribute("required",!0)),verificationTimer&&clearInterval(verificationTimer);let r=e,a="";(g=300<e)?a=[`${Math.floor(r/3600).toString().padStart(2,"0")}:${Math.floor(r%3600/60).toString().padStart(2,"0")}:`+(r%60).toString().padStart(2,"0"),h.VERIFICATION_LOCKED.message]:!g&&step.verification?a=[Math.floor(r/60).toString().padStart(2,"0")+":"+(r%60).toString().padStart(2,"0"),h.VERIFICATION_LOCKED.message]:g||(a=[Math.floor(r/60).toString().padStart(2,"0")+":"+(r%60).toString().padStart(2,"0"),h.SMS_CODE_TIMER.message]);e=t===d.VERIFICATION?v:p;u(a,e,!!(g||!g&&step.verification)&&"error");let s=e.querySelector(".timer");verificationTimer=setInterval(()=>{r<=0?(clearInterval(verificationTimer),step.verification?(E.disabled=!1,m.disabled=!1,q(v)):(_.disabled=!1,_.textContent="НАДІСЛАТИ ПОВТОРНО",_.setAttribute("data-translate","resendConfirmationCode"),f.setAttribute("required",!1),f.disabled=!0,f.value="",p.dataset.confirmationExpired="true",q(p),u(h.VERIFICATION_EXPIRED.message,p,"error"))):(s&&(g?s.textContent=`${Math.floor(r/3600).toString().padStart(2,"0")}:${Math.floor(r%3600/60).toString().padStart(2,"0")}:`+(r%60).toString().padStart(2,"0"):s.textContent=Math.floor(r/60).toString().padStart(2,"0")+":"+(r%60).toString().padStart(2,"0")),r--)},1e3)}),i=e=>{var t,r,a,s;"true"===p.dataset.confirmationExpired&&(p.querySelectorAll(".input-msg").forEach(e=>e.remove()),p.dataset.confirmationExpired="false"),e.ok?(verificationSession=e.data.session_id,p.classList.contains("hidden")&&(v.classList.add("hidden"),v.classList.remove("visible"),p.classList.add("visible"),p.classList.remove("hidden"),p.classList.add("code-placeholder"),p.setAttribute("data-placeholder","_ _ _ _ _")),step.verification=!1,step.confirmation=!0,t=e.data.phone_verification_ttl,n(t,d.CONFIRMATION)):-24===e.code&&"verification_locked"===e.message.reason?(t=e.message.rest_time,s=step.verification?E:_,r=step.verification?m:f,q((a=step.verification?d.VERIFICATION:d.CONFIRMATION)===d.VERIFICATION?v:p),s.disabled=!0,r.disabled=!0,step.confirmation&&(r.value=""),n(t,a)):-24===e.code&&"phone_number_has_been_confirmed_by_another_user"===e.message.reason?u(h.PHONE_CONFIRMED_BY_ANOTHER.message,v,"error"):-4===e.code&&"wrong_session_or_confirm_code"===e.message.reason?(_.disabled=!0,f.value="",u(h.INVALID_CONFIRMATION_CODE.message,p,"error")):-24===e.code&&"confirm_code_locked"===e.message.reason&&(q(p),s=e.message.rest_time,_.disabled=!0,f.disabled=!0,f.value="",n(s,d.CONFIRMATION))};m.addEventListener("input",e=>{E.disabled=!0,m.classList.remove("is-invalid");var t=e.target.value.replace(/\D/g,""),r=(e.target.value=(e=>{if(!e)return"+380";if(e.length<=3)return"+"+e;const t=e.slice(0,3),r=e.slice(3,5),a=e.slice(5,8),s=e.slice(8,10),o=e.slice(10,12);let n="+"+t;return r&&(n+="("+r),a&&(n+=")-"+a),s&&(n+="-"+s),o&&(n+="-"+o),n})(t),t||e.target.setSelectionRange(4,4),v),t=(r.classList.add("phone-placeholder"),r.setAttribute("data-placeholder",(e=>{if(e.length<=3)return"+380(XX)-XXX-XX-XX";const t="+380",r=e.slice(3,5).padEnd(2,"X"),a=5<e.length?e.slice(5,8).padEnd(3,"X"):"XXX",s=8<e.length?e.slice(8,10).padEnd(2,"X"):"XX",o=10<e.length?e.slice(10,12).padEnd(2,"X"):"XX";return`${t}(${r})-${a}-${s}-`+o})(t)),r=e.target.value,/^\+380\d{9}$/.test(r)),r=(E.disabled=!t,t?m.classList.remove("is-invalid"):m.classList.add("is-invalid"),e.target.value.slice(1)===o);E.innerHTML=r?"ПІДТВЕРДИТИ":"ЗБЕРЕГТИ",E.setAttribute("data-translate",r?"confirm":"save")}),m.addEventListener("click",e=>{e.target.selectionStart<=4&&e.target.setSelectionRange(4,4)}),m.addEventListener("mousedown",e=>{e.target.selectionStart<=4&&(e.preventDefault(),e.target.setSelectionRange(4,4))}),m.addEventListener("keydown",e=>{var t=e.target.selectionStart;"ArrowLeft"===e.key&&t<=4&&e.preventDefault(),("Backspace"===e.key||"Delete"===e.key)&&t<=4&&e.preventDefault(),!e.shiftKey||"ArrowLeft"!==e.key&&"ArrowRight"!==e.key||("ArrowLeft"===e.key?t-1:t+1)<=4&&e.preventDefault()}),f.addEventListener("input",e=>{_.disabled=!0,f.classList.remove("is-invalid");var t=e.target.value;let r=t.replace(/[^0-9]/g,"");t!==r&&(e.target.value=r);var e=f.parentElement,a=(e.classList.contains("code-placeholder")||e.classList.add("code-placeholder"),Array(5).fill("_").map((e,t)=>t<r.length?r[t]:t===r.length?"_":" _").join("")),e=(e.setAttribute("data-placeholder",a),p.querySelector('[data-code-error="true"]'));e&&e.remove(),/^\d{5}$/.test(t)?_.disabled=!1:f.classList.add("is-invalid")}),v.addEventListener("submit",async e=>{e.preventDefault(),step.verification=!0,E.disabled=!0,submittedPhone=e.target[0].value;try{var t,r=user.data.account.id,a=new FormData;if(a.append("phone",submittedPhone),a.append("userid",r),submittedPhone!=="+"+o)"no"!==(t=await(async e=>{try{var t=await(await fetch("/accounting/api/change_user",{method:"POST",body:e})).json();return console.log("changeUserPhone response:",t),t}catch(e){throw console.error("Error changing user phone:",e),e}})(a)).error||t.error_code?"yes"===t.error&&"accounting_error_02"===t.error_code&&(E.disabled=!1,u(h.PHONE_ALREADY_USED.message,v,"error")):(q(v),o=t.phone.slice(1),E.innerHTML="ПІДТВЕРДИТИ",E.disabled=!1,v.classList.add("success-change"),setTimeout(()=>{v.classList.remove("success-change")},4e3));else{showLoading(d.VERIFICATION);var s=await l(cid);if(!s)throw s;hideLoading(d.VERIFICATION),i(s)}}catch(e){console.error("Verification process failed:",e),E.disabled=!1}}),p.addEventListener("submit",async e=>{if(e.preventDefault(),step.verification=!1,step.confirmation=!0,_.disabled=!0,"true"===p.dataset.confirmationExpired)try{showLoading(d.CONFIRMATION);var t=await l(cid);t&&(hideLoading(d.CONFIRMATION),i(t))}catch(e){console.error("Error resending verification code:",e)}else{e=f.value;try{if(showLoading(d.CONFIRMATION),(await(async(e,t)=>{try{var r=await window.FE.socket_send({cmd:"accounting/user_phone_confirm",data:{confirm_code:""+e,session_id:""+t}});return console.log("confirmUserPhone response",r),r}catch(e){throw console.error("Error confirming user phone:",e),e}})(e,verificationSession)).ok){S.classList.add("hidden"),A.classList.remove("hidden");var r={userid:user.data.account.id,phone:submittedPhone};try{await fetch(a+"/"+s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})}catch(e){throw console.error("Error adding verification:",e),e}}}catch(e){console.error("Error confirming code:",e),hideLoading(d.CONFIRMATION),i(e)}}})});let n=document.querySelector(".fav__page");setTimeout(()=>n.classList.add("overflow"),1e3)})();