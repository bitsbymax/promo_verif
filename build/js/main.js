(()=>{let E={INVALID_PHONE_FORMAT:{message:"Формат телефону вказано неправильно",translateKey:"errorInvalidPhoneFormat"},PHONE_ALREADY_USED:{message:"Цей номер телефону вже використовується",translateKey:"errorPhoneAlreadyUsed"},PHONE_CONFIRMED_BY_ANOTHER:{message:"Цей номер телефону було підтверджено іншим користувачем",translateKey:"errorPhoneConfirmedByAnother"},VERIFICATION_EXPIRED:{message:"Час верифікації минув",translateKey:"errorVerificationExpired"},INVALID_CONFIRMATION_CODE:{message:"Неправильний код підтвердження",translateKey:"errorInvalidConfirmationCode"},VERIFICATION_LOCKED:{message:"верифікацію заблоковано. Дочекайтесь оновлення таймера",translateKey:"errorVerificationLocked"},SMS_CODE_TIMER:{message:"час, який залишився, щоб ввести код з SMS-повідомлення. Після закінчення часу можна запросити код повторно",translateKey:"smsCodeTimer"}},h="https://fav-prom.com",_="api_verification";var e=document.querySelector("#ukLeng"),t=document.querySelector("#enLeng");let n=sessionStorage.getItem("locale")?sessionStorage.getItem("locale"):"uk",a=(e&&(n="uk"),t&&(n="en"),{});function r(){var e=document.querySelectorAll("[data-translate]"),t=(e&&e.length&&e.forEach(e=>{var t=e.getAttribute("data-translate");e.innerHTML=(e=>{if(e)return a[e]||"*----NEED TO BE TRANSLATED----*   key:  "+e})(t),e.removeAttribute("data-translate")}),"en"===n&&m.classList.add("en"),void 0),r=void 0;if(t){for(var o of["uk","en"])t.classList.remove(r+o);t.classList.add(r+n)}}async function y(e){try{var t=await window.FE.socket_send({cmd:"accounting/user_phone_verify",cid:e});return console.log("verifyUserPhone response",t),t}catch(e){return console.error("Error verifying user phone:",e),e}}function b(e,t,r=!1){var o,n,a,s,i=t.querySelector("input"),d=t.querySelector("button");"confirmation__form"===t.id&&"true"===t.dataset.confirmationExpired&&t.querySelectorAll(".input-msg").forEach(e=>e.remove());let c=null;for(o in E)if(E[o].message===e){c=E[o];break}for(n of t.querySelectorAll(".input-msg"))if(!n.hasAttribute("data-code-error")){if(Array.isArray(e)&&2===e.length){var l=n.querySelector(".timerWrapper");if(l){l=l.querySelector(".timer");if(l)return void(l.textContent=e[0])}}else if(n.textContent===e)return;n.remove()}let u=document.createElement("div");u.classList.add("input-msg"),Array.isArray(e)&&2===e.length?((a=document.createElement("div")).classList.add("timerWrapper"),a.style.minWidth=r?"65px":"45px",(s=document.createElement("span")).textContent=e[0],s.classList.add("timer"),a.appendChild(s),(s=document.createElement("span")).textContent=e[1],s.classList.add(r?"error":"warning"),e[1]===E.VERIFICATION_LOCKED.message?s.setAttribute("data-translate",E.VERIFICATION_LOCKED.translateKey):e[1]===E.SMS_CODE_TIMER.message&&s.setAttribute("data-translate",E.SMS_CODE_TIMER.translateKey),u.appendChild(a),u.appendChild(document.createTextNode(" ")),u.appendChild(s)):(u.textContent=e,c&&u.setAttribute("data-translate",c.translateKey)),u.classList.add(r?"error":"warning"),"Неправильний код підтвердження"===e?(u.setAttribute("data-code-error","true"),i.parentNode.insertBefore(u,i.nextSibling),t.querySelectorAll(".input-msg:not([data-code-error])").forEach(e=>{u.parentNode.insertBefore(e,u.nextSibling)})):(s=(a=t.querySelector("[data-code-error]"))?a.nextSibling:d,i.parentNode.insertBefore(u,s))}function s(e){return/^\+380\d{9}$/.test(e)}function i(e){e.querySelectorAll(".input-msg").forEach(e=>e.remove())}let d=document.getElementById("phone"),I=document.getElementById("confirmation-code"),c=document.getElementById("verification__form"),S=document.querySelector(".link__button-wrapper"),l=document.getElementById("submit-button"),u=document.querySelector(".button-authorized"),L=document.querySelector(".button-notAuthorized"),A=(document.querySelector(".button-success"),document.querySelector(".button-successBefore")),C=document.querySelector(".button-dark"),O=!1,N=!0,R=!1,w=!1,m=(fetch(`${h}/${_}/translates/`+n).then(e=>e.json()).then(e=>{a=e,r(),new MutationObserver(function(e){r()}).observe(document.getElementById("verification"),{childList:!0,subtree:!0})}).then(async function(){console.log("%c init fired","color: #00ff00; font-weight: bold"),console.log("%c init fired","color: #00ff00; font-weight: bold");let t=()=>{console.log("Updating UI, states:",{authorized:O,notAuthorized:N,successBefore:w,success:R});var e=document.querySelector(".form__wrapper"),t=document.querySelector(".form__container"),r=document.querySelector(".form__container-successBefore");N?(console.log("not authorized"),e?.classList.add("hidden"),S?.classList.add("visible")):O?(console.log("authorized"),S?.classList.add("hidden"),S?.classList.remove("visible"),e?.classList.remove("hidden"),c?.classList.add("visible"),c?.classList.remove("hidden")):w&&(console.log("successBefore"),t?.classList.add("hidden"),r?.classList.remove("hidden"))},m=(u.addEventListener("click",e=>{e.preventDefault(),console.log("authorizedButton clicked"),O=!0,N=!1,R=!1,w=!1,t()}),L.addEventListener("click",e=>{e.preventDefault(),console.log("notAuthorizedButton clicked"),O=!1,N=!0,R=!1,w=!1,t()}),A.addEventListener("click",e=>{e.preventDefault(),console.log("successBeforeButton clicked"),O=!1,N=!1,R=!1,w=!0,t()}),C.addEventListener("click",e=>{e.preventDefault(),"uk"===n?(sessionStorage.setItem("locale","en"),window.location.reload()):"en"===n&&(sessionStorage.setItem("locale","uk"),window.location.reload())}),t(),document.getElementById("confirmation__form")),f=document.getElementById("confirm-button"),g=null,a=null,p=null,o=(e,{confirmation:r=!1,verification:o=!1})=>{f.textContent="НАДІСЛАТИ",f.setAttribute("data-translate","sendConfirmationCode"),a&&clearInterval(a);let n=e;a=setInterval(()=>{var e,t;n<=0?(clearInterval(a),f.disabled=!1,f.textContent="НАДІСЛАТИ ПОВТОРНО",f.setAttribute("data-translate","resendConfirmationCode"),i(c),(e=document.getElementById("confirmation-code")).value="",e.required=!1,m.dataset.confirmationExpired="true",b(E.VERIFICATION_EXPIRED.message,m,"error")):(e=Math.floor(n/60),t=n%60,o&&b([`${Math.floor(n/3600).toString().padStart(2,"0")}:${Math.floor(n%3600/60).toString().padStart(2,"0")}:`+(n%60).toString().padStart(2,"0"),E.VERIFICATION_LOCKED.message],c,"error"),r&&b([e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0"),E.SMS_CODE_TIMER.message],m,!1),n--)},1e3)},v=e=>{console.log("response from verifyUserPhone inside handleVerificationResponse",e);var t,r={confirmation:!1,verification:!1};e.ok?(g=e.data.session_id,m.classList.contains("hidden")&&(c.classList.add("hidden"),c.classList.remove("visible"),m.classList.add("visible"),m.classList.remove("hidden")),r.confirmation=!0,t=e.data.phone_verification_ttl,o(t,r)):-24===e.code&&"verification_locked"===e.message.reason?(t=e.message.rest_time,l.disabled=!0,d.disabled=!0,r.verification=!0,o(t,r)):-24===e.code&&"phone_number_has_been_confirmed_by_another_user"===e.message.reason&&(l.disabled=!1,b(E.PHONE_CONFIRMED_BY_ANOTHER.message,c,"error"))};d.addEventListener("input",e=>{var t=e.target.value;d.classList.remove("is-invalid"),s(t)?i(c):d.classList.add("is-invalid"),e.target.value.slice(1)===userPhoneNumber?(l.innerHTML="ПІДТВЕРДИТИ",l.setAttribute("data-translate","confirm")):(l.innerHTML="ЗБЕРЕГТИ",l.setAttribute("data-translate","save"))}),I.addEventListener("input",e=>{e.target.value=e.target.value.replace(/[^0-9]/g,""),5!==e.target.value.length?e.target.classList.add("is-invalid"):e.target.classList.remove("is-invalid")}),c.addEventListener("submit",async e=>{if(e.preventDefault(),console.log("%c Form submitted","color: #ff00ff; font-weight: bold",e),l.disabled=!0,s(p=e.target[0].value)){i(c);try{var t,r=null.data.account.id,o=new FormData;if(o.append("phone",p),o.append("userid",r),p!=="+"+userPhoneNumber)console.log("TRY CHANGE USER PHONE---VERIF FORM"),"no"!==(t=await(async e=>{try{var t=await(await fetch("/accounting/api/change_user",{method:"POST",body:e})).json();return console.log("changeUserPhone response:",t),t}catch(e){throw console.error("Error changing user phone:",e),e}})(o)).error||t.error_code?"yes"===t.error&&"accounting_error_02"===t.error_code&&(l.disabled=!1,b(E.PHONE_ALREADY_USED.message,c,"error")):(i(c),userPhoneNumber=t.phone.slice(1),l.innerHTML="ПІДТВЕРДИТИ",l.disabled=!1);else{console.log("TRY VERIFY USER PHONE---VERIF FORM");var n=await y(null);if(!n)throw n;v(n)}}catch(e){console.error("Verification process failed:",e),l.disabled=!1}}else b(E.INVALID_PHONE_FORMAT.message,c,"error"),l.disabled=!1}),m.addEventListener("submit",async e=>{if(e.preventDefault(),f.disabled=!0,console.log("submitter phone",p),"true"===m.dataset.confirmationExpired){m.dataset.confirmationExpired="false",document.getElementById("confirmation-code").required=!0;try{console.log("TRY VERIFY USER PHONE---CONF FORM");var t=await y(null);t&&v(t)}catch(e){console.error("Error resending verification code:",e)}f.disabled=!1}else{e=I.value;if(/^\d{5}$/.test(e))try{if(console.log("TRY CONFIRM USER PHONE---CONF FORM"),(await(async(e,t)=>{try{var r=await window.FE.socket_send({cmd:"accounting/user_phone_confirm",data:{confirm_code:""+e,session_id:""+t}});return console.log("confirmUserPhone response",r),r}catch(e){throw console.error("Error confirming user phone:",e),e}})(e,g)).ok){document.querySelector(".form__wrapper").style.display="none";var r=document.querySelector(".form__header"),o=(r.textContent="ТВІЙ НОМЕР ВЕРИФІКОВАНО",r.setAttribute("data-translate","formHeaderSuccess"),document.querySelector(".form__description")),n=(o.textContent='Ваш персональний бонус зараховано в розділ "Бонуси"',o.setAttribute("data-translate","formDescriptionSuccess"),document.querySelector(".successImageWrapper")),a=(n.classList.add("visible"),n.classList.remove("hidden"),document.createElement("div")),s=(a.className="successImageWrapper-prizeInfo",document.createElement("span")),i=(s.textContent="СТРАХОВКА ДО",s.setAttribute("data-translate","prizeInfoInsurance"),document.createElement("span")),d=(i.textContent="СТАВКИ 100 ₴",i.setAttribute("data-translate","prizeInfoValue"),a.appendChild(s),a.appendChild(i),document.createElement("div")),c=(d.className="successImageWrapper-bonusSpark",n.appendChild(a),n.appendChild(d),S.style.display="flex",document.querySelector(".link__button-wrapper a")),l=(c.href="/personal-office/bonuses/betinsurance",c.textContent="ДО БОНУСУ",c.setAttribute("data-translate","confirmSuccess"),null.data.account.id),u={userid:l,phone:p};try{await fetch(h+"/"+_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)})}catch(e){throw console.error("Error adding verification:",e),e}await void 0}}catch(e){console.error("Error confirming code:",e),-4===e.code&&"wrong_session_or_confirm_code"===e.message.reason&&b(E.INVALID_CONFIRMATION_CODE.message,m,"error")}finally{f.disabled=!1}else console.log("inside validate fn() ---code is invalid"),I.classList.add("is-invalid"),f.disabled=!1}})}),document.querySelector(".fav__page"));setTimeout(()=>m.classList.add("overflow"),1e3)})();